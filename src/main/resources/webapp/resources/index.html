<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title> Destinations </title>
</head>

<body>

<h1>Destinations by country : </h1>
<ul id="list"></ul>
<div id="destinationList"></div>

<form>
    <label for="countries">Choose a country:</label>
    <select id="countries" name="countries" onchange="generateData(this)">
        <option value="germany">Germany</option>
        <option value="italy">Italy</option>
        <option value="spain">Spain</option>
        <option value="france">France</option>
        <option value="romania">Romania</option>
    </select>
</form>
<br>
<button onclick="nextDestinations()">Next destinations</button>
<br>

<h1>View all destinations :</h1>
<button onclick="next()">Next</button>
<button onclick="previous()">Previous</button>

<h1>Add new destination : </h1>
<form id="form" onsubmit="postData(event)">
    <input id="city" name="city" placeholder="City" type="text" required>
    <input id="country" name="country" placeholder="Country" type="text" required>
    <input id="description" name="description" placeholder="Description" type="text" required>
    <input id="targets" name="targets" placeholder="Targets" type="text" required>
    <input id="cost" name="cost" placeholder="Cost" type="number" required>

    <input type="submit" value="Submit">
</form>

<script>

var menu = document.getElementById("countries");

function generateData(menu) {
    if (menu.value == 'germany') {
        getDestinations('Germany')
    } else if (menu.value == 'italy') {
        getDestinations('Italy')
    } else if (menu.value == 'spain') {
        getDestinations('Spain')
    } else if (menu.value == 'france') {
        getDestinations('Franta')
    } else if (menu.value == 'romania') {
        getDestinations('Romania')
    }
}

var result;
var index;

function getDestinations(countryName){
            index=2;
            var items;
            var url = '/api/destinations'
            clearChildren()

            fetch(url)
                         .then(res => res.json())
                         .then(json => {
                                items = json
                                result = items.filter(x => x.country === countryName);
                                var resultSliced = result.slice(0,index);
                                resultSliced.forEach(function(dest){
                                    li = document.createElement('li')
                                    ul.appendChild(li)

                                    li.innerHTML += "<strong>City: </strong>" + dest.city + ", <strong> Country: </strong>" + dest.country;
                            })
                         })
                         .catch(function(error) {
                                console.log(error);
                         });

}


function nextDestinations(){
            clearChildren()
            partialResult = result.slice(index,index+2);
            partialResult.forEach(function(dest){
                      li = document.createElement('li')
                      ul.appendChild(li)
                      li.innerHTML += "<strong>City: </strong>" + dest.city + ", <strong> Country: </strong>" + dest.country;
            })

            index = index + 2
}


startIndex = 0
var ul = document.getElementById("list");
document.getElementById("destinationList").appendChild(ul);
var li;

function clearChildren(){
    while (ul.lastElementChild) {
          ul.removeChild(ul.lastElementChild);
    }
}

function next() {
            var items;
            var url = '/api/next/'+startIndex

            clearChildren()

            fetch(url)
                         .then(res => res.json())
                         .then(json => {
                                items = json
                                items.forEach(function(dest){
                                    li = document.createElement('li')
                                    ul.appendChild(li)

                                    li.innerHTML += "<strong>City: </strong>" + dest.city + ", <strong> Country: </strong>" + dest.country;
                            })
                         })
                         .catch(function(error) {
                                console.log(error);
                         });
            startIndex = startIndex + 4
}

function previous() {
            var items;
            startIndex = startIndex - 4
            var url = 'api/previous/'+startIndex
            clearChildren()
            fetch(url)
                         .then(res => res.json())
                         .then(json => {
                                items = json
                                items.forEach(function(dest){
                                    li = document.createElement('li')
                                    ul.appendChild(li)

                                    li.innerHTML += "<strong>City: </strong>" + dest.city + ", <strong> Country: </strong>" + dest.country;
                            })
                         })
                         .catch(function(error) {
                                console.log(error);
                         });

}

function postData(event) {
    event.preventDefault();
    const form = document.getElementById('form');
    let rawData = new FormData(form);

    let data = {};
    for(let pair of rawData.entries()) {
     data[pair[0]] = pair[1];
    }
    var targetList = data.targets.split(",");
    data.targets = targetList
    let contactData = JSON.stringify(data);

    new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/destination');
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onerror = () => reject(xhr.statusText);
                    xhr.send(contactData);
    });

}





</script>


</body>
</html>